Bootstrap: docker
From: nvidia/cuda:12.8.1-devel-ubuntu24.04

%labels
    Author "Isaac For Healthcare"
    Maintainer "isaac-for-healthcare"
    Description "Singularity image for i4h robotic_surgery workflow"

%environment
    export NVIDIA_VISIBLE_DEVICES=all
    export NVIDIA_DRIVER_CAPABILITIES=graphics,video,compute,utility,display
    export PATH=/root/miniconda3/bin:$PATH
    export PYTHONPATH=/workspace/i4h-workflows/workflows/robotic_surgery/scripts
    export RTI_LICENSE_FILE=/root/rti/rti_license.dat

%files
    ../../../tools /workspace/i4h-workflows/tools
    ../../../workflows /workspace/i4h-workflows/workflows

%post
    set -e
    export DEBIAN_FRONTEND=noninteractive

    # Base packages
    apt-get update && \
        apt-get install -y \
            wget \
            curl \
            jq \
            vim \
            git \
            xvfb \
            build-essential \
            cmake \
            vulkan-tools \
            unzip \
            lsb-release \
            libglib2.0-0 \
            libdbus-1-3 \
            libopengl0 \
            libxcb-keysyms1 \
            libglu1-mesa && \
        rm -rf /var/lib/apt/lists/*

    mkdir -p /workspace/i4h-workflows

    # Install Miniconda and create environment
    mkdir -p /root/miniconda3 && \
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /root/miniconda3/miniconda.sh && \
        bash /root/miniconda3/miniconda.sh -b -u -p /root/miniconda3 && \
        rm /root/miniconda3/miniconda.sh

    source /root/miniconda3/bin/activate && \
        conda tos accept && \
        conda init --all && \
        conda create -n robotic_surgery python=3.11 -y

    # Install workflow dependencies
    source /root/miniconda3/bin/activate && \
        conda activate robotic_surgery && \
        cd /workspace/i4h-workflows && \
        BUILD_DOCKER_IMAGE=true bash tools/env_setup_robot_surgery.sh

%runscript
    exec /bin/bash "$@"
